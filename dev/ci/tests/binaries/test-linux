#!/usr/bin/env bash
# This script is from the "Passenger binaries test" Jenkins job. It runs
# runs tests on the binaries generated by the "build-linux" script.
#
# Required environment variables:
#
#   WORKSPACE
#   ARCHITECTURE
#   DOCKER_ARCH
#
# Optional environment variables:
#
#   PASSENGER_ROOT (defaults to $WORKSPACE)
#   OUTPUT_DIR (defaults to $WORKSPACE/output)
#   ENTERPRISE

set -e
SELFDIR=$(dirname "$0")
cd "$SELFDIR/../../../../packaging/binaries"
# shellcheck source=../../../../packaging/binaries/shared/lib/library.sh
source "./shared/lib/library.sh"

require_envvar WORKSPACE "$WORKSPACE"
require_envvar ARCHITECTURE "$ARCHITECTURE"
require_envvar DOCKER_ARCH "$DOCKER_ARCH"

PASSENGER_ROOT="${PASSENGER_ROOT:-$WORKSPACE}"
OUTPUT_DIR="${OUTPUT_DIR:-$WORKSPACE/output}"

EXTRA_TEST_PARAMS=()
if [[ "$ENTERPRISE" = 1 ]]; then
	EXTRA_TEST_PARAMS=(-L /etc/passenger-enterprise-license)
fi

run mkdir -p "$OUTPUT_DIR"
run mkdir -p "$CACHE_DIR"

run ./linux/package \
	-i "$OUTPUT_DIR" \
	-o "$OUTPUT_DIR" \
	-a "$ARCHITECTURE"
run ./linux/test \
	-p "$PASSENGER_ROOT" \
	-i "$OUTPUT_DIR" \
	-I "$OUTPUT_DIR" \
	-A "$DOCKER_ARCH" \
	"${EXTRA_TEST_PARAMS[@]}"
